<?php
include 'koneksi.php';

// Ambil id produk
$id = isset($_GET['id']) ? (int) $_GET['id'] : 0;
if ($id <= 0) {
    header('Location: index.php');
    exit;
}

// Ambil detail produk
$sql = "SELECT p.*, u.nama_penjual AS nama_penjual, u.telepon, u.alamat_lengkap, k.nama_kecamatan
        FROM produk p 
        LEFT JOIN penjual u ON u.id_penjual = p.id_penjual
        LEFT JOIN kecamatan k ON k.id_kecamatan = u.id_kecamatan
        WHERE p.id_produk = ?";

$stmt = mysqli_prepare($conn, $sql);
mysqli_stmt_bind_param($stmt, 'i', $id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$produk = mysqli_fetch_assoc($result);

if (!$produk) {
    http_response_code(404);
    echo "Produk tidak ditemukan.";
    exit;
}

// Produk lainnya
$sqlOthers = "SELECT id_produk, nama_produk, harga, satuan, gambar 
              FROM produk 
              WHERE id_produk != ? 
              ORDER BY RAND() 
              LIMIT 6";
$stmt3 = mysqli_prepare($conn, $sqlOthers);
mysqli_stmt_bind_param($stmt3, 'i', $id);
mysqli_stmt_execute($stmt3);
$produkLain = mysqli_stmt_get_result($stmt3);

// Helper Rupiah
function rupiah($angka) {
    return "Rp " . number_format($angka, 0, ',', '.');
}
?>
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
        <?= htmlspecialchars($produk['nama_produk']); ?> - E-Hasper
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            --green-color: #3cb815;
            --light-green-color: #c0eb7b;
            --orange-color: #ff7e00;
            --light-orange-color: #f75f1d;
            --text-color: #1a2428;
            --bg-color: #ffffff;
        }

        body {
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
        }

        .price {
            color: var(--green-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .badge-stock {
            background: var(--light-green-color);
            color: #1a2428;
        }

        .btn-cart {
            background: var(--light-orange-color);
            color: #fff;
        }

        .btn-cart:hover,
        .btn-orange:hover {
            background: var(--orange-color);
            color: #fff;
        }

        .btn-orange {
            background-color: var(--light-orange-color);
            color: #fff;
            border: none;
        }

        .btn-checkout {
            background: #198754;
            color: #fff;
        }

        .btn-checkout:hover {
            background: #146c43;
        }

        .thumb-main-container {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #fff;
            text-align: center;
        }

        .thumb-main {
            max-height: 300px;
            width: auto;
            object-fit: contain;
        }

        .wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--bg-color);
            border: none;
            border-radius: 50%;
            padding: 6px 9px;
            color: var(--light-orange-color);
            font-size: 1.1rem;
            z-index: 2;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        .wishlist-btn:hover {
            background: var(--light-orange-color);
            color: #fff;
        }

        .thumb-related {
            height: 160px;
            object-fit: cover;
        }

        .card-related {
            position: relative;
            transition: .2s;
        }

        .card-related:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
        }

        .nav-tabs .nav-link.active {
            background-color: var(--light-orange-color);
            color: #fff;
        }

        .action-icons .btn {
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.php">
                <i class="bi bi-shop" style="color:var(--light-orange-color);"></i> E-Hasper
            </a>
        </div>
    </nav>

    <!-- Detail Produk -->
    <section class="py-4">
        <div class="container">
            <div class="row g-4">
                <!-- Gambar -->
                <div class="col-md-5 position-relative">
                    <div class="thumb-main-container">
                        <img src="uploads/produk/<?= htmlspecialchars($produk['gambar']); ?>"
                            alt="<?= htmlspecialchars($produk['nama_produk']); ?>" class="thumb-main img-fluid">
                    </div>
                    <!-- Wishlist Button -->
                    <button class="wishlist-btn" title="Tambah ke Wishlist">
                        <i class="bi bi-heart"></i>
                    </button>
                </div>

                <!-- Info Produk -->
                <div class="col-md-7">
                    <h1 class="h3">
                        <?= htmlspecialchars($produk['nama_produk']); ?>
                    </h1>
                    <div class="mb-2">
                        <?php if (!empty($produk['kategori'])): ?>
                        <span class="badge text-bg-secondary">Kategori:
                            <?= htmlspecialchars($produk['kategori']); ?>
                        </span>
                        <?php endif; ?>
                        <?php if (isset($produk['stok'])): ?>
                        <span class="badge badge-stock ms-2">Stok:
                            <?= (int) $produk['stok']; ?>
                        </span>
                        <?php endif; ?>
                    </div>
                    <p class="price mb-2">
                        <?= rupiah($produk['harga']); ?> /
                        <?= htmlspecialchars($produk['satuan']); ?>
                    </p>

                    <!-- Nama Penjual -->
                    <?php if (!empty($produk['nama_penjual'])): ?>
                    <p><i class="bi bi-person-circle"></i> Penjual:
                        <strong>
                            <?= htmlspecialchars($produk['nama_penjual']); ?>
                        </strong>
                    </p>
                    <?php endif; ?>
                    <?php if (!empty($produk['nama_kecamatan'])): ?>
                    <p>
                        <i class="bi bi-geo-alt-fill text-danger"></i> Lokasi: Kec.
                        <strong>
                            <?= htmlspecialchars($produk['nama_kecamatan']); ?>
                        </strong>,
                        <?= !empty($produk['alamat_lengkap']) 
        ? nl2br(htmlspecialchars($produk['alamat_lengkap'])) 
        : 'Alamat Tidak Tersedia.'; ?>
                    </p>

                    <?php endif; ?>
                    <!-- Form keranjang -->
                    <div class="mb-3">
                        <label for="qty" class="form-label small">Jumlah</label>
                        <input type="number" name="qty" class="form-control w-25" value="1" min="1"
                            <?=isset($produk['stok']) ? 'max="' .(int)$produk['stok'].'"' : '' ; ?>>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="login.php" class="btn btn-cart">
                            <i class="bi bi-cart-plus"></i> Keranjang
                        </a>
                        <a href="login.php" class="btn btn-checkout">
                            <i class="bi bi-credit-card"></i> Checkout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Nav Tabs -->
            <ul class="nav nav-tabs mt-5" id="productTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc"
                        type="button" role="tab">Deskripsi</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button"
                        role="tab">Ulasan</button>
                </li>
            </ul>
            <div class="tab-content p-3 border border-top-0" id="productTabContent">
                <div class="tab-pane fade show active" id="desc" role="tabpanel">
                    <?= !empty($produk['deskripsi']) ? nl2br(htmlspecialchars($produk['deskripsi'])) : 'Belum ada deskripsi produk.'; ?>

                </div>
                <div class="tab-pane fade" id="review" role="tabpanel">
                    <p>Belum ada ulasan untuk produk ini.</p>
                </div>
            </div>

            <!-- Produk Lainnya -->
            <?php if (mysqli_num_rows($produkLain) > 0): ?>
            <hr class="my-5">
            <h4 class="mb-3">Produk Lainnya</h4>
            <div class="row g-3">
                <?php while ($r = mysqli_fetch_assoc($produkLain)) : ?>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card card-related h-100 position-relative">
                        <button class="wishlist-btn" title="Tambah ke Wishlist">
                            <i class="bi bi-heart"></i>
                        </button>
                        <img src="uploads/produk/<?= htmlspecialchars($r['gambar']); ?>"
                            class="card-img-top thumb-related" alt="<?= htmlspecialchars($r['nama_produk']); ?>">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title mb-1">
                                <?= htmlspecialchars($r['nama_produk']); ?>
                            </h6>
                            <p class="text-success mb-2">
                                <?= rupiah($r['harga']); ?>/
                                <?= htmlspecialchars($r['satuan']); ?>
                            </p>
                            <div class="d-flex gap-2 mt-auto action-icons">
                                <a href="detail_produk.php?id=<?= $r['id_produk']; ?>" class="btn btn-sm btn-orange"
                                    title="Lihat Detail">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <form action="tambah_keranjang.php" method="POST" class="m-0 p-0">
                                    <input type="hidden" name="id_produk" value="<?= $r['id_produk']; ?>">
                                    <button type="submit" class="btn btn-sm btn-orange" title="Tambah ke Keranjang">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <?php endwhile; ?>
            </div>
            <?php endif; ?>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>